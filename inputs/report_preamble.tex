% Set up FONTS to use.
\usepackage[bitstream-charter]{mathdesign}
\usepackage{fontspec}
\DeclareSymbolFont{usualmathcal}{OMS}{cmsy}{m}{n}
\DeclareSymbolFontAlphabet{\mathcal}{usualmathcal}

\setmainfont[Scale=0.9]{CharisSIL}[%
  Path=$HOME/.fonts/truetype/ ,
  Extension      = .ttf       ,
  UprightFont    = *-R        ,
  ItalicFont     = *-I        ,
  BoldFont       = *-B        ,
  BoldItalicFont = *-BI       ,
]
\defaultfontfeatures[Charis SIL]{Script=latn, Ligatures=TeX}

% To indicate current chapter name and number in the header.
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{#1}{#1}}
\fancyhead[R]{}
\fancyhead[L]{\chaptername\ \thechapter\ --\ \leftmark \hfill \thepage}

% For fancy chapter header.
\usepackage{titlesec, blindtext, color}
\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}
\titleformat{\chapter}[hang]{\Huge\bfseries}{\thechapter\hsp\textcolor{gray75}{|}\hsp}{0pt}{\Huge\bfseries}

% -------------------------------------------------------
% -------------------------------------------------------
% ------------------- CUSTOM STUFF ----------------------
% -------------------------------------------------------
% -------------------------------------------------------

%
% Packages.
%

\usepackage{amsmath}
\let\circledS\undefined
\usepackage{amssymb}
% Needed for \text{} command, which escapes mathmode in a \newcommand's.
\usepackage{amstext}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{calc}
\usepackage[font=small,
            labelfont=bf]{caption} % Proper formatting for caption text.
\usepackage{enumitem}
\usepackage{epigraph}
\usepackage{etoolbox}

% Basically increase text width.
\usepackage[top=2.5cm, bottom=2.5cm, left=3.5cm, right=3.5cm]{geometry}

% For graphics inclusion.
\usepackage{graphicx}

\usepackage{mathtools}
\usepackage[outputdir=build]{minted}

% For making urls clickable.
\usepackage{xurl}

%
% (Re)new commands. (Except those that are part of a specific setup).
%

% I like this approach for \divides, but the negation must be with \nmid.
\newcommand\divides{\ensuremath{\mathrel{|}}}

\newcommand{\emd}{\textemdash}
\newcommand{\fn}[1]{\footnote{#1}}

%
% Number and symbol-less footnote. I use it to add the sources for quotes in the
% chapter initial page.
%
\newcommand\fnnosym[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

% For (mathematical) function declarations.
\newcommand\funcdecl[3]{#1\colon #2 \rightarrow #3}

\newcommand{\myemph}[1]{{\text{\SchemataFont\small\upshape#1}}}

\newcommand{\para}[1]{\noindent\textbf{#1}}

% Security game EAV-security.
\newcommand{\privkeav}{{\text{\SchemataFont\small\upshape PrivK\rlap{\textsuperscript{\raisebox{2pt}{eav}}}\textsubscript{$\mathcal{A}$, $\Pi$}}}}
\newcommand{\privkeavprime}{{\text{\SchemataFont\small\upshape%
PrivK\rlap{\textsuperscript{\raisebox{2pt}{eav}}}%
\textsubscript{$\mathcal{A}$, $\widetilde{\Pi}$}}}}

% To get a filled black square at the end of proofs.
\renewcommand\qedsymbol{$\blacksquare$}

\newlength{\widthsuperscript}
\newlength{\widthsubscript}
\newcommand{\sgg}[1]{{\text{\SchemataFont\small\upshape#1}}}
\newcommand{\sg}[4]{{\text{%
\setlength{\widthsuperscript}{\widthof{#2}}%
\setlength{\widthsubscript}{\widthof{$\mathcal{#3}$, $#4$}}%
\SchemataFont\small\upshape%
\ifdim\widthsubscript>\widthsuperscript%
#1\rlap{\textsuperscript{\raisebox{2pt}{#2}}}\textsubscript{$\mathcal{#3}$, $#4$}%
\else%
#1\rlap{\textsubscript{$\mathcal{#3}$, $#4$}}\textsuperscript{\raisebox{2pt}{#2}}%
\fi%
}}}

% For ยง symbol. Some TeX compilers might complain if it is entered literally,
% so use this command instead.
\newcommand{\ts}{\textsection}

%
% All other custom stuff.
%

% For tables, side by side.
\usepackage{subcaption}
\captionsetup[subfigure]{labelformat=simple}
\renewcommand\thesubfigure{(\alph{subfigure})}

% \setsansfont{/usr/share/texmf-dist/fonts/opentype/public/tex-gyre/texgyreheros-regular.otf}
% \renewcommand{\familydefault}{\sfdefault}
% Font to use for security games' names.
\newfontfamily\SchemataFont{Arial}

% \newfontfamily\SchemataFont{texgyreheros}[%
%   Path=/usr/share/texmf-dist/fonts/opentype/public/tex-gyre/,
%   Extension      = .otf        ,
%   UprightFont    = *-regular   ,
%   ItalicFont     = *-italic    ,
%   BoldFont       = *-bold      ,
%   BoldItalicFont = *-bolditalic,
% ]
% \newcommand\SchemataFont{\renewcommand{\familydefault}{\sfdefault}}
% \setmainfont[Mapping=tex-text, Color=textcolor]{SourceSansPro Light}

\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
% 'def' cannot be used as environ name.
\newtheorem{definition}[theorem]{Definition}
\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}

% Ensures enumerations of theorems et al are similar.
\AtBeginEnvironment{theorem}{%
  \setlist[enumerate]{label={\upshape(\roman*)}}}

% To make emphasis in definitions et al. yield upright bold text.
\AtBeginEnvironment{theorem}{\renewcommand\em{\upshape\bfseries}}
\AtBeginEnvironment{definition}{\renewcommand\em{\upshape\bfseries}}
\AtBeginEnvironment{lemma}{\renewcommand\em{\upshape\bfseries}}
\AtBeginEnvironment{corollary}{\renewcommand\em{\upshape\bfseries}}
% \AtBeginEnvironment{remark}{\renewcommand\em{\upshape\bfseries}}

% Make the names of theorems et al bold.
\makeatletter
\def\th@plain{%
\thm@notefont{}% optional name font same as heading font
\itshape% body font
}
\makeatother

% To accomplish the same for remark.
\makeatletter
\def\th@remark{%
\thm@headfont{\bfseries}%
\thm@notefont{}% optional name font same as heading font
\normalfont % body font
\thm@preskip\topsep \divide\thm@preskip\tw@
\thm@postskip\thm@preskip
}
\makeatother

% If no newline at the end of theorem, then don't indent the following paragraph.
\makeatletter
\patchcmd{\@endtheorem}{\@endpefalse}{}{}{}
\patchcmd{\endproof}{\@endpefalse}{}{}{}
\makeatother

% Add ending symbols to remark and example.
\newcommand{\addQEDstyle}[2]{%
\AtBeginEnvironment{#1}{\pushQED{\qed}\renewcommand{\qedsymbol}{#2}}%
\AtEndEnvironment{#1}{\popQED}}
\addQEDstyle{remark}{$\triangle$}
\addQEDstyle{example}{$\lozenge$}

\newcommand\swapifbranches[3]{#1{#3}{#2}}
\makeatletter
\MHInternalSyntaxOn
\patchcmd{\DeclarePairedDelimiter}{\@ifstar}{\swapifbranches\@ifstar}{}{}
\MHInternalSyntaxOff
\makeatother

\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
\DeclarePairedDelimiter\parens{\lparen}{\rparen}
\DeclarePairedDelimiter\sparens{\[}{\]}
\DeclarePairedDelimiter\cparens{\{}{\}}
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}


% Epigraph
\newcommand{\mytextformat}{\epigraphsize\itshape}
\newcommand{\mysourceformat}{\epigraphsize\scshape}
\newenvironment{mytext}{\mytextformat}{}
\newenvironment{mysource}{\mysourceformat\hfill}{}
\renewcommand{\textflush}{flushleft} 
\renewcommand{\sourceflush}{flushright}
\newlength{\epitextlen}
\newlength{\episourcelen}
\newlength{\epilength}

\let\originalepigraph\epigraph 

% usage: \epigraph[<length>]{<quote>}{<author>}
\renewcommand\epigraph[3][0.8]%
{ %
	\setlength{\epitextlen}{\widthof{\mytextformat#2}}%
	\setlength{\episourcelen}{\widthof{\mysourceformat#3}}%
	\ifdim\epitextlen>\episourcelen%
		\setlength{\epilength}{\epitextlen}%
	\else%
		\setlength{\epilength}{\episourcelen}%
	\fi%
	% \wlog{\epitextlen}
	% \wlog{\episourcelen}
	\ifdim\epilength>#1\textwidth%
		\setlength{\epilength}{#1\textwidth}%
	\fi%
	\setlength{\epigraphwidth}{\epilength}%
	\originalepigraph{\mytextformat#2}{\mysourceformat#3}%
}


% -------------------------------------------------------
% -------------------------------------------------------
% ------------------- END CUSTOM STUFF ------------------
% -------------------------------------------------------
% -------------------------------------------------------

% Language and bibliography. Language with polyglossia must be set before
% biblatex is used, or error ensues. But it's probably good advice with babel
% and bibtex also.
% For Portuguese, replace "UKenglish" with "portuges".
\usepackage[UKenglish]{babel}
\usepackage[comma, numbers]{natbib}
\renewcommand{\bibsection}{\chapter*{References}}  % name the bib chapter References.
\usepackage{url}
% Make bib listing with <number><dot>.
\makeatletter
\renewcommand\@biblabel[1]{\textrm{#1.}}
\makeatother
% \renewcommand{\UrlFont}{\small\tt}

% hyperref et al.
% ***NOTA BENE:*** The hyperref package if used, MUST BE THE LAST ONE included!
%
\usepackage{xcolor} % For MidnightBlue colour!
\providecolors{MidnightBlue}
\usepackage[bookmarks=true,
            citecolor=MidnightBlue,
            colorlinks=true,
            hyperfootnotes=false,
            linkcolor=MidnightBlue,
            linktocpage=true,
            pagebackref=true,
            urlcolor=MidnightBlue]{hyperref}
\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
  \ifcase #1 Not cited.%
    \or Cited on page~#2.%
    \else Cited on pages~#2.%
  \fi}
